<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Server.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Conditions.Condition.html">Condition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Conditions.Condition.html#getType">getType</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Conditions.IntervalCondition.html">IntervalCondition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Conditions.IntervalCondition.html#getType">getType</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Conditions.ThresholdCondition.html">ThresholdCondition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Conditions.ThresholdCondition.html#getType">getType</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Devices.Controller.html">Controller</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Devices.Device.html">Device</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Device.html#disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Device.html#enable">enable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Device.html#getStatus">getStatus</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Devices.Sensor.html">Sensor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#enable">enable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#getData">getData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#getLatestData">getLatestData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#getStatus">getStatus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#read">read</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Devices.Sensor.html#sample">sample</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Garden.Garden.html">Garden</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.Garden.html#disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.Garden.html#enable">enable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.Garden.html#getDevice">getDevice</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.Garden.html#getGardenStatus">getGardenStatus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.Garden.html#loadController">loadController</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.Garden.html#loadSensor">loadSensor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Garden.GardenEvent.html">GardenEvent</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Trigger.html">Trigger</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TriggerManager.html">TriggerManager</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Utils.Logger.html">Logger</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="View.html">View</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Grow-Controller.html">Grow-Controller</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Triggers.html#event:ConditionInternal">ConditionInternal</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Devices.html">Devices</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Garden.html">Garden</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Triggers.html">Triggers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Triggers.html#.createCondition">createCondition</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#__gardendir">__gardendir</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#__gardenfile">__gardenfile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#_db">_db</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#log">log</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">Server.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable no-extend-native */
const ipc = require('node-ipc');
const path = require('path');
const dotenv = require('dotenv');
dotenv.config();
process.env.PROJECT_ROOT = path.normalize(path.join(__dirname, '/..'));


let inGarden;
let garden;

if (process.argv[2] !== undefined) {
    try { 
        inGarden = path.isAbsolute(process.argv[2]) ? inGarden: path.resolve(process.cwd(), process.argv[2]);
        console.log(inGarden);
        /** @global */
        global.__gardendir = path.dirname(inGarden);
        /** @global */       
        global.__gardenfile = inGarden;
        const {Logger} = require('../backend');
        const log = new Logger();
        /**@global */
        global.log = log;
        garden = require(inGarden);
    } catch (err) {
        console.error('Could Not Find Garden at: %s \n %o', inGarden, err);
    }
}

const {
    Garden
} = require('../backend');

if (garden instanceof Garden) {
    
    /* Initialize Inter Process Communiciation */
    ipc.config.id = garden.name;
    ipc.config.retry = 1500;

    ipc.serve(() => {
        console.log('Server Started');
    });

    /* IPC Event Listeners Defined Here */

    //Start Command Listener
    ipc.server.on('app.start', (data, socket) => {
        //TODO Confirm These Things.
        garden.enable();
        ipc.server.emit(socket, 'done', 0);
        ipc.log('Garden Started: ', data);
    });

    //Stop Command Listener
    ipc.server.on('app.stop', (data, socket) => {
        garden.disable();
        //ipc.log('Socket: ', socket);
        
        ipc.server.emit(socket, 'done', 0);
        
        ipc.log('Garden Stopped: ', data);
    });

    ipc.server.on('app.read', (data, socket) => {
        let sensor = garden.getDevice(data)
        //ipc.log(garden.getDevice(data));
        ipc.log(sensor.read());
    });

    //Status Command Listener
    ipc.server.on('app.getStatus', (data, socket) => {
        let statusTemplate = {};

        if (typeof data == 'string') {
            let sensor = Object.getOwnPropertyDescriptor(garden, data).value;
            ipc.server.emit(socket, 'render', sensor.getGardenStatus());
        } else {
            let gardenStatus = garden.getGardenStatus();
            /*statusTemplate.title = gardenStatus.garden;
            statusTemplate.fields = Object.keys(gardenStatus.sensors[0]);
            statusTemplate.values = [];
            gardenStatus.sensors.forEach(row => {
                statusTemplate.values.push(Object.values(row));
            });
            statusTemplate.values.push() */

            let statusOut = formatter(gardenStatus.garden, gardenStatus.sensors, gardenStatus.controllers);
            ipc.log(statusOut);
            
            ipc.server.emit(socket, 'render', statusOut);
        }
    });

    ipc.server.start();
} else {
    console.error("No Garden was Found!");
    process.exit(10);
}


const formatter = (title, ...objects) => {
    let formattedOut = {
        title: title,
        lists: []
    };
    let format = {
        values: []
    };
    let keys = [];
    let counter = 0;
    if(objects instanceof Array){
        format.fields = (Object.keys(objects[0][0]));
        keys[counter] = Object.keys(objects[0][0]);
        objects.forEach((object, n) => {
            if(object instanceof Array){
                //format.fields = (Object.keys(object[0]));
                var seenKeys = false;
                var stickyCounter = undefined;
                object.forEach((obj, i) => {
                    if(!format.fields.equals(Object.keys(obj))){
                         //If we see a difference in the field lists stop this format List.
                          //might need to swap this to the end of the function Or not
                         formattedOut.lists[counter] = format;
                         format = {
                             values: []
                         };
                         format.fields = (Object.keys(obj));

                         let foundKeyPos = format.fields.findInArray(keys);
                         if(foundKeyPos !== false){
                            seenKeys = true;
                            stickyCounter = foundKeyPos;
                            formattedOut.lists[stickyCounter].values.push(Object.values(obj));
                             //console.log("Found Key Pos: ", foundKeyPos);
                         } else {
                            format.values.push(Object.values(obj));
                         }
                         keys[counter + 1] = Object.keys(object[0]);
                         counter++;
                    } else {
                        if(seenKeys){
                            formattedOut.lists[stickyCounter].values.push(Object.values(obj));
                        } else {
                            format.values.push(Object.values(obj));  
                        }                                          
                    }
                });
                if(!seenKeys) formattedOut.lists[counter] = format;
            } else {
                //TODO HANDLE NO ARRAY CASES
            }
        });
    } else {

    }
    return formattedOut;
}

//#region 
// Warn if overriding existing method
if(Array.prototype.equals)
    console.warn("Overriding existing Array.prototype.equals. Possible causes: New API defines the method, there's a framework conflict or you've got double inclusions in your code.");
// attach the .equals method to Array's prototype to call it on any array
Array.prototype.equals = function (array) {
    // if the other array is a falsy value, return
    if (!array)
        return false;

    // compare lengths - can save a lot of time 
    if (this.length != array.length)
        return false;

    for (var i = 0, l=this.length; i &lt; l; i++) {
        // Check if we have nested arrays
        if (this[i] instanceof Array &amp;&amp; array[i] instanceof Array) {
            // recurse into the nested arrays
            if (!this[i].equals(array[i]))
                return false;       
        }           
        else if (this[i] != array[i]) { 
            // Warning - two different object instances will never be equal: {x:20} != {x:20}
            return false;   
        }           
    }       
    return true;
}
// Hide method from for-in loops
Object.defineProperty(Array.prototype, "equals", {enumerable: false});

Array.prototype.findInArray = function (arrays){
    var index, array;

    for(index = 0; index &lt; arrays.length; index++){
        if(this.equals(arrays[index])){
            return index;
        }
    }
    return false;
}

Object.defineProperty(Array.prototype, "findInArray", {enumerable: false});
//#endregion
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Wed Nov 20 2019 15:45:04 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
