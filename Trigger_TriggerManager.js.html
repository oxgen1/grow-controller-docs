<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Trigger/TriggerManager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Controller.html">Controller</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Controller.html#disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Controller.html#enable">enable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Controller.html#getStatus">getStatus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Controller.html#registerActionEvent">registerActionEvent</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Device.html">Device</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#enable">enable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Device.html#getStatus">getStatus</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Garden.html">Garden</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.html#disable">disable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.html#enable">enable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.html#getDevice">getDevice</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.html#getGardenStatus">getGardenStatus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.html#loadController">loadController</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Garden.html#loadSensor">loadSensor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="GardenEvent.html">GardenEvent</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="IntervalCondition.html">IntervalCondition</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Logger.html">Logger</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ThresholdCondition.html">ThresholdCondition</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Trigger.html">Trigger</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TriggerManager.html">TriggerManager</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="View.html">View</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Grow-Controller.html">Grow-Controller</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Triggers.html">Triggers</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">Trigger/TriggerManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const createCondition = require('./Condition');
const EventEmitter = require('events');
/**
 * The Trigger Manager Class 
 */
class TriggerManager {
  /**
   * Creates an instance of TriggerManager.
   * @constructs TriggerManager
   * @param {Garden} garden {@link Garden}
   * @namespace Trigger
   * @memberof TriggerManager
   */
  constructor(garden) {
    garden.triggerManager = this;
    this.gardenEmitter = garden.emitter;
    this.emitter = new EventEmitter();
    this.triggers = [];
    this.debug = true;
  }


  /**
   * Creates A Trigger Object
   * @constructs Trigger
   * @param {Condition} condition {@link Condition} 
   * @param {String} actionEvent - Event Listener Name connected with the Controller Action Will. Emit GardenEvent Emitter
   * @memberof TriggerManager
   */
  createTrigger(condition, actionEvent) {
    /**
     * Loads the Condition Setting specific Properties Defined in the Trigger Object
     * @function
     * @private
     * @param {Condition} condition {@link Condition}
     */
    var load = (condition) => {
      //Lets add an Id
      //Define Triggers Internal Event at the Condition Level
      condition.event = trigger.internalEvent;

        //If this is a ThresholdCondition
        if (condition.getType() === 'ThresholdCondition') {
          var _condition = {};
          _condition = Object.assign(_condition, condition);

          //If its a sensor Linked Conditional Trigger Condition
          if (condition.hasOwnProperty('sensor')) {
            condition.read = () => {
              let data = condition.lastData;
              return data[condition.dataField];
            }
            condition.evaluateState = _condition.function;
            condition.function = (value) => {
              log.debug('Condition Expression: ' + value + ' ' + condition.operator + ' ' + condition.threshold)('condition');
              log.debug('Condition Value: ', value)('condition');
              let state = _condition.function(value);
              log.debug('Condition State: ', state)('condition');
              condition.lastTriggered = Date.now();
              condition.lastState = state;
              if (state) {
                try {
                  log.debug('Value Truethy: ', state)('condition');
                  condition.lastEmitted = Date.now();
                  this.emitter.emit(condition.event, condition, trigger);
                } catch (err) {
                  console.error('Error While Trying to Emit Internal Condition Event: ', err);
                }
              }
              return state;
            }
          }
          //If this condition is Interval Type
        } else if (condition.getType() === 'IntervalCondition') {
          condition.function = () => {
            condition.intervalObj = setInterval(() => {
              this.emitter.emit(condition.event, condition, trigger);
            }, condition.interval);
          }
        }
      }

    /**
     * @namespace Trigger
     * @property {int} id - The Id of the Trigger
     * @property {EventEmitter} emitter {@link EventEmitter}
     * @property {String} actionEvent - The event that this Trigger will trigger when it meets the conditions set
     * @property {String} internalEvent - An Internal Event that triggers before the actionEvent when one of the conditions are met
     * @property {Array.&lt;Condition>|Array.linkingObjects} logic - An Array of Conditions and Linking Objects 
     */
    let trigger = {
      id: this.triggers.length,
      emitter: this.emitter,
      actionEvent: actionEvent,
      internalEvent: actionEvent + '-' + this.triggers.length,
      logic: [],
      triggerLimiter: undefined, // If this is set then we will only trigger off this one. Should be value of condition
      getInitCondition: function () {
        return this.logic[this.logic.map(e => e.type).indexOf('init') + 1];
      },
      getLogic: function () {
        return this.logic;
      },
      and: function (condition) {
        load(condition);
        this.logic.push({
          type: 'and'
        });
        this.logic.push(condition);
        return this;
      },
      or: function (condition) {
        load(condition);
        this.logic.push({
          type: 'or'
        });
        this.logic.push(condition);
        return this;
      },
      checkOtherConditions(condition) {
        let lastTriggered = condition.lastTriggered;
        //TODO Remove it's redudent (This can be done on the Reduce function)
        let evaluatedArry = this.logic.map((value, index) => {
          //For now we are gonna decide if its the same condition by looking at the lastTriggered field, this may have unintended implications but we if see lastTriggered is not the same we want to reevaluate that conditional anyway
          if (value.hasOwnProperty("type")) { // These will be our linking Objects
            if (value.type == 'init') {
              return 'init';
            } else if (value.type == 'and') {
              return '&amp;&amp;';
            } else if (value.type == 'or') {
              return '||';
            }
          } else if (value.isEvaluable) {
            if (value.lastTriggered > lastTriggered - 5000 &amp;&amp; value.lastTriggered &lt; +5000) {
              return value.lastState;
            } else {
              let v = value.read();
              return value.evaluateState(v);
            }
          }
        });
        return evaluatedArry;
      },
      init: function () {
        let registerListener = () => {

          let evaluateOtherConditions = (condition) => {
            if (condition.isEvaluable) {
              let evaluatedArr = this.checkOtherConditions(condition);
              let result = evaluatedArr.reduce((acc, curr, i, arr) => {
                //console.log("accumulator: ", acc);
                //console.log("current value: ", curr);
                if (i == 1) {
                  acc = curr;
                }
                if (curr == '&amp;&amp;') {
                  acc = acc &amp;&amp; arr[i + 1];
                } else if (curr == '||') {
                  acc = acc || arr[i + 1];
                }
                return acc;
              });
              log.info('Trigger Emitter Result: ', result, condition)('trigger');
              log.debug('Trigger Emitter evaluated Array: ', evaluatedArr, trigger)('trigger');
            }
          }
          //TODO Make Unique
          let internalEvent = this.internalEvent;
          let actionEvent = this.actionEvent;

          /**
           * This Defines Our Trigger Level Listener and will have all the logic to decide if we send the Garden Level Event or not
           */
          this.emitter.on(internalEvent, (condition, trigger) => {
            log.debug(`[${condition.getType()}] Condition Triggered Internal Event Emitted On: `, condition)('trigger');
            if(typeof this.triggerLimiter !== "undefined"){
              if(this.triggerLimiter.id !== condition.id) return;
            }
            evaluateOtherConditions(condition);
          });
        }


        let logic = this.getLogic();
        let type;
        logic.forEach((logicE, i) => {
          //if we have a type property we can assume it is a linking object
          if (logicE.hasOwnProperty('type')) {
            type = logicE.type;
          } else {
            if (logicE.getType() === 'ThresholdCondition') {
              if (logicE.hasOwnProperty('sensor')) {
                logicE.sensor.dataStream.on('data', (data) => {
                  log.debug("data recived: ", data[logicE.dataField])('condition');
                  logicE.lastData = data;
                  logicE.function(data[logicE.dataField]);
                });
              }
            } else if (logicE.getType() === 'IntervalCondition') {
              logicE.function();
            }
          }
        });
        registerListener();

        return this;
      }
    }
    //TODO Handle Timebased cases, You will need to create a read function and a function that tests the case

    load(condition);
    if (condition.getType() === "IntervalCondition" &amp;&amp; condition.isTriggerAble) {
      trigger.triggerLimiter = condition;
    }
    trigger.logic.push({
      type: 'init'
    });
    trigger.logic.push(condition);
    return trigger;
  }
}

module.exports = TriggerManager;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Mon Nov 04 2019 17:32:56 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
